#!/bin/bash

# Check if correct number of arguments are provided
if [ "$#" -lt 2 ]; then
    echo "Usage: $0 <file_path> <target_filename>"
    exit 1
fi

DEBUG_ACTION=${DEBUG_ACTION:-"false"}
file_path="$1"
target_filename="$2"

# Get the directory of the given file path
search_dir=$(dirname "$file_path")

# Traverse upwards until the file is found
while [ "$search_dir" != "/" ]; do
    if [ -f "$search_dir/$target_filename" ]; then
        if [ "$DEBUG_ACTION" == "true" ]; then
          echo "Found file: $search_dir/$target_filename"
        fi

        # Extract first metadata.name under kind: Component
        # This ensures we don't take a `System` entities name
        name_value=$(awk '
            $1 == "kind:" && $2 == "Component" {found=1} 
            found && $1 == "metadata:" {in_metadata=1} 
            in_metadata && $1 == "name:" {print $2; exit}' "$search_dir/$target_filename" | tr -d ' ')

        # If name_value is not empty, print it and exit
        if [ -n "$name_value" ]; then
            echo "$name_value"
            exit 0
        else
            echo "Error: No Component kind or metadata.name found in $target_filename"
            exit 1
        fi
    fi

    # Move one level up
    search_dir=$(dirname "$search_dir")
done

# If no file is found
echo "No file named '$target_filename' found."
exit 1
